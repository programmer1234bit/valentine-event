<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Void | AI Love Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Poppins:wght@300;400;600&display=swap');
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(to bottom, #fff5f7, #ffe4e6); 
            padding: 20px; 
            min-height: 100vh; 
            overflow-x: hidden; 
        }

        .romantic-font { font-family: 'Dancing Script', cursive; }
        
        .vibe-btn { transition: all 0.3s ease; border: 2px solid transparent; cursor: pointer; }
        .active-vibe { border-color: #e11d48; background: #fff1f2 !important; color: #e11d48; transform: scale(1.05); }
        .active-vibe span:last-child { color: #e11d48 !important; }
        
        .ai-output-card { 
            background: white; 
            border: 2px solid #fecdd3; 
            padding: 25px; 
            border-radius: 1.5rem; 
            margin-top: 20px; 
            cursor: pointer; 
            transition: 0.3s; 
        }
        .ai-output-card:hover { 
            border-color: #e11d48; 
            transform: translateY(-3px); 
            box-shadow: 0 10px 15px rgba(0,0,0,0.05); 
        }

        .loader { border-top-color: #e11d48; animation: spinner 0.6s linear infinite; }
        @keyframes spinner { to { transform: rotate(360deg); } }

        .heart { 
            position: fixed; 
            bottom: -20px; 
            pointer-events: none; 
            animation: floatUp linear forwards; 
            z-index: 1; 
            font-size: 20px; 
            color: #e11d48; 
        }
        
        @keyframes floatUp { 
            0% { transform: translateY(0) rotate(0deg); opacity: 1; } 
            100% { transform: translateY(-110vh) rotate(360deg); opacity: 0; } 
        }
    </style>
</head>
<body class="max-w-xl mx-auto pb-20 relative">

    <div class="text-center py-10">
        <h1 class="romantic-font text-6xl text-red-600 mb-2">Love Library</h1>
        <p class="text-gray-400 text-xs uppercase tracking-[0.2em]">Personalized Name & Meaning AI ‚ù§Ô∏è</p>
    </div>

    <div class="bg-white p-6 rounded-3xl shadow-sm border border-red-50 mb-6 relative z-10">
        <label class="block text-[10px] font-bold text-gray-400 mb-4 uppercase tracking-widest text-center">Recipient Profile</label>
        
        <div class="grid grid-cols-2 gap-3 mb-4">
            <input id="targetName" type="text" placeholder="Name (e.g. Neema)" 
                   class="p-4 rounded-xl border border-red-50 outline-none text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-100 transition">
            <input id="personality" type="text" placeholder="Personality (e.g. Kind)" 
                   class="p-4 rounded-xl border border-red-50 outline-none text-sm bg-gray-50 focus:bg-white focus:ring-2 focus:ring-red-100 transition">
        </div>

        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="setVibe(this, 'Romantic')" class="vibe-btn active-vibe p-4 rounded-2xl flex flex-col items-center bg-gray-50">
                <span class="text-2xl mb-1">‚ù§Ô∏è</span>
                <span class="text-[10px] font-bold uppercase">Romance</span>
            </button>
            <button onclick="setVibe(this, 'Friendly')" class="vibe-btn bg-gray-50 p-4 rounded-2xl flex flex-col items-center">
                <span class="text-2xl mb-1">ü§ù</span>
                <span class="text-[10px] font-bold uppercase text-gray-500">Bestie</span>
            </button>
            <button onclick="setVibe(this, 'Healing')" class="vibe-btn bg-gray-50 p-4 rounded-2xl flex flex-col items-center">
                <span class="text-2xl mb-1">ü©π</span>
                <span class="text-[10px] font-bold uppercase text-gray-500">Forgive</span>
            </button>
            <button onclick="setVibe(this, 'Family')" class="vibe-btn bg-gray-50 p-4 rounded-2xl flex flex-col items-center">
                <span class="text-2xl mb-1">üè†</span>
                <span class="text-[10px] font-bold uppercase text-gray-500">Family</span>
            </button>
        </div>

        <input id="customHint" type="text" placeholder="Special detail (e.g. 'our coffee shop date')"
               class="w-full p-4 mb-6 rounded-xl border border-red-100 outline-none text-sm text-gray-600 italic">
       
        <button onclick="askAI()" id="genBtn" class="w-full bg-red-600 text-white py-4 rounded-full font-bold shadow-lg flex items-center justify-center gap-2 transition active:scale-95">
            <span id="btnText">Generate Name-Meaning Magic ‚ú®</span>
            <div id="btnLoader" class="hidden w-4 h-4 border-2 border-white rounded-full loader"></div>
        </button>

        <div class="relative my-8">
            <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-gray-100"></span></div>
            <div class="relative flex justify-center text-[10px] uppercase tracking-widest text-gray-300 bg-white px-4 font-bold">Or</div>
        </div>

        <button onclick="window.location.href='library.html'" class="w-full border-2 border-dashed border-red-200 text-red-400 py-4 rounded-full font-bold flex items-center justify-center gap-2 hover:bg-red-50 transition active:scale-95">
            <span>Browse Classic Library üìñ</span>
        </button>
    </div>

    <div id="resultWrapper" class="hidden relative z-10">
        <p class="text-center text-[10px] text-gray-400 uppercase tracking-widest mb-2 font-bold">Click card to use this message</p>
        <div id="aiText" class="ai-output-card italic text-gray-700 text-xl leading-relaxed text-center shadow-sm">
            <span id="messageText"></span>
        </div>
        <div class="flex justify-center gap-4 mt-4">
            <button onclick="copyToClipboard()" class="text-xs text-red-500 border border-red-300 px-4 py-1 rounded-full hover:bg-red-50 transition">Copy üìã</button>
            <button onclick="shareMessage()" class="text-xs text-red-500 border border-red-300 px-4 py-1 rounded-full hover:bg-red-50 transition">Share ‚ù§Ô∏è</button>
        </div>
    </div>

    <div class="text-center mt-12 relative z-10">
        <a href="index.html" class="text-xs text-gray-300 hover:text-red-400 transition underline">‚Üê Return to Hub</a>
    </div>

    <script>
    const API_KEY = "YOUR API KEY "; 
    let selectedVibe = "Romantic";

    function setVibe(btn, vibe) {
        document.querySelectorAll('.vibe-btn').forEach(b => {
            b.classList.remove('active-vibe');
            b.classList.add('bg-gray-50');
            b.querySelector('span:last-child').classList.add('text-gray-500');
        });
        btn.classList.add('active-vibe');
        btn.classList.remove('bg-gray-50');
        btn.querySelector('span:last-child').classList.remove('text-gray-500');
        selectedVibe = vibe;
    }

    async function askAI() {
    const nameInput = document.getElementById('targetName').value;
    const personality = document.getElementById('personality').value;
    const hint = document.getElementById('customHint').value;
    const btn = document.getElementById('genBtn');
    const loader = document.getElementById('btnLoader');
    const textSpan = document.getElementById('btnText');
    const messageText = document.getElementById('messageText');

    if(!nameInput.trim()) return alert("Please enter a name first!");

    btn.disabled = true;
    loader.classList.remove('hidden');
    textSpan.innerText = "Writing your story...";

    // THE FIX: We tell the AI to wrap the final message in unique tags [MESSAGE]...[/MESSAGE]
    // This makes it impossible for the code to grab unfinished "thoughts".
    const prompt = `Task: Write a 5-sentence Valentine's letter for ${nameInput}.
    Context: ${selectedVibe} theme, ${personality} personality, and mention "${hint}".
    
    1. Start with the meaning of the name ${nameInput}.
    2. Write exactly 5 sentences.
    3. You MUST end the 5th sentence with a period.
    4. Important: Put the final letter inside [START] and [END] tags so I know you finished.`;

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${API_KEY}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    temperature: 0.8,
                    maxOutputTokens: 1000, // Very high limit
                }
            })
        });

        const data = await response.json();
        const candidate = data?.candidates?.[0];
        
        if (candidate && candidate.content && candidate.content.parts) {
            // Grab the text part
            const textParts = candidate.content.parts.filter(p => p.text);
            let fullText = textParts[textParts.length - 1].text;

            // REGEX FIX: This looks for content between [START] and [END] 
            // to make sure we only get the FINISHED message.
            const match = fullText.match(/\[START\]([\s\S]*?)\[END\]/);
            let generatedText = match ? match[1].trim() : fullText.trim();

            // Safety Cleanup
            generatedText = generatedText.replace(/\[START\]|\[END\]/g, "").trim();

            // FINAL CHECK: If it doesn't end in punctuation, it's incomplete. 
            // We force a period or ask it to try again.
            if (!/[.!?]$/.test(generatedText)) {
                generatedText += "."; 
            }

            messageText.innerText = generatedText;
            document.getElementById('resultWrapper').classList.remove('hidden');
            document.getElementById('resultWrapper').scrollIntoView({ behavior: 'smooth' });

            document.getElementById('aiText').onclick = () => {
                localStorage.setItem('libMessage', generatedText);
                localStorage.setItem('libName', nameInput);
                localStorage.setItem('libVibe', selectedVibe.toLowerCase());
                window.location.href = 'index.html';
            };
        }
    } catch (err) {
        alert("The muse is shy. Try clicking generate again!");
    } finally {
        btn.disabled = false;
        loader.classList.add('hidden');
        textSpan.innerText = "Generate New ‚ú®";
    }
}

    function copyToClipboard() {
        const text = document.getElementById('messageText').innerText;
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => alert('Copied to heart! ‚ù§Ô∏è'));
    }

    function shareMessage() {
        const text = document.getElementById('messageText').innerText;
        if (navigator.share && text) {
            navigator.share({ title: "A Message for You", text });
        }
    }

    function spawnHeart() {
        if (document.querySelectorAll('.heart').length > 15) return;
        const h = document.createElement('div');
        h.className = 'heart'; 
        h.innerHTML = '‚ù§Ô∏è';
        h.style.left = Math.random() * 100 + 'vw';
        h.style.animationDuration = (Math.random() * 3 + 4) + 's';
        document.body.appendChild(h);
        setTimeout(() => h.remove(), 6000);
    }
    
    setInterval(spawnHeart, 800);
    </script>
</body>
</html>